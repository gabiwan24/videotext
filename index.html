<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Kamera-Texterkennung (Echtzeit-Overlay)</title>
    <!-- Tailwind CSS für das Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- p5.js Bibliothek -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.js"></script>
    <!-- Tesseract.js Bibliothek für OCR -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #111827;
        }
        #canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .ui-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            pointer-events: none; 
        }
        .ui-element {
            pointer-events: auto;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans">

    <div id="canvas-container"></div>

    <div class="ui-overlay p-4 sm:p-6 flex justify-center items-end">
        <div class="ui-element w-full max-w-xl bg-gray-900/70 backdrop-blur-sm p-4 rounded-xl shadow-lg">
              <div class="flex flex-col items-center justify-center gap-4">
                   <!-- Slider für die Sichtbarkeit des Videobilds -->
                  <div class="w-full">
                      <label for="visibility-slider" class="block text-sm font-medium mb-2 text-center text-white">Sichtbarkeit Video: <span id="visibility-value" class="font-bold">10</span>%</label>
                      <input id="visibility-slider" type="range" min="0" max="100" value="10" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                  </div>
                  <div id="status-container" class="w-full h-8 text-center text-sm text-gray-300">
                      <p id="status-text">Initialisiere Kamera...</p>
                      <div id="progress-bar-container" class="w-full bg-gray-700 rounded-full h-2.5 mt-1 hidden">
                          <div id="progress-bar" class="bg-indigo-500 h-2.5 rounded-full" style="width: 0%"></div>
                      </div>
                  </div>
              </div>
        </div>
    </div>

    <script>
        let capture;
        let p5Canvas;
        let videoReady = false;
        let isRecognizing = false;
        
        // NEU: Variablen für das responsive Layout
        let drawX, drawY, drawW, drawH;
        
        let recognizedWords = [];
        let worker;
        
        let backgroundAlpha = 230; // Entspricht 10% Sichtbarkeit

        // UI Elemente
        const statusText = document.getElementById('status-text');
        const progressBarContainer = document.getElementById('progress-bar-container');
        const progressBar = document.getElementById('progress-bar');
        const visibilitySlider = document.getElementById('visibility-slider');
        const visibilityValue = document.getElementById('visibility-value');

        async function initializeTesseract() {
            statusText.textContent = "Initialisiere Texterkennung...";
            worker = await Tesseract.createWorker('deu', 1, {
                logger: updateStatus,
            });
            statusText.textContent = "Bereit. Halte Text vor die Kamera.";
            setInterval(performRecognition, 1500);
        }

        function setup() {
            const canvasContainer = document.getElementById('canvas-container');
            // GEÄNDERT: Canvas füllt jetzt das ganze Fenster
            p5Canvas = createCanvas(windowWidth, windowHeight);
            p5Canvas.parent('canvas-container');
            pixelDensity(1);
            
            capture = createCapture(VIDEO, () => {
                videoReady = true;
                statusText.textContent = "Kamera bereit.";
                // NEU: Layout nach dem Start der Kamera berechnen
                calculateLayout();
                initializeTesseract();
            });
            // Fordert eine Standardauflösung an, die dann skaliert wird
            capture.size(640, 480);
            capture.hide();

            visibilitySlider.addEventListener('input', (e) => {
                const visibility = parseInt(e.target.value);
                visibilityValue.textContent = visibility;
                backgroundAlpha = map(visibility, 0, 100, 255, 0);
            });
        }
        
        // NEU: Funktion zur Berechnung des responsiven Layouts
        function calculateLayout() {
            if (!capture || capture.width === 0) return;
            const videoRatio = capture.width / capture.height;
            const windowRatio = width / height;

            if (windowRatio > videoRatio) {
                drawH = height;
                drawW = height * videoRatio;
                drawX = (width - drawW) / 2;
                drawY = 0;
            } else {
                drawW = width;
                drawH = width / videoRatio;
                drawX = 0;
                drawY = (height - drawH) / 2;
            }
        }

        function draw() {
            // Zuerst einen komplett schwarzen Hintergrund zeichnen
            background(0);

            if(videoReady) {
                // GEÄNDERT: Das Kamerabild wird jetzt ungespiegelt und responsiv gezeichnet
                image(capture, drawX, drawY, drawW, drawH);
            }

            // Dann den halbtransparenten schwarzen Hintergrund darüber legen
            background(0, backgroundAlpha);

            if (recognizedWords.length > 0) {
                for (const word of recognizedWords) {
                    // GEÄNDERT: Die Position wird jetzt auf das responsive Layout umgerechnet
                    const displayX = map(word.x, 0, capture.width, drawX, drawX + drawW);
                    const displayY = map(word.y, 0, capture.height, drawY, drawY + drawH);
                    const displayH = map(word.h, 0, capture.height, 0, drawH);
                    
                    fill(255);
                    noStroke();
                    textFont('Arial');
                    textAlign(LEFT, TOP);
                    textSize(displayH * 0.8);
                    text(word.text, displayX, displayY);
                }
            }
        }
        
        function updateStatus(message) {
            statusText.textContent = message.status;
            if (message.status === 'recognizing text') {
                progressBarContainer.classList.remove('hidden');
                const progress = (message.progress * 100).toFixed(2);
                progressBar.style.width = `${progress}%`;
            } else {
                 progressBarContainer.classList.add('hidden');
            }
        }

        async function performRecognition() {
            if (isRecognizing || !videoReady || !worker) return;

            isRecognizing = true;
            
            // Die Analyse erfolgt weiterhin auf dem Originalbild der Kamera
            const imageData = capture.canvas.toDataURL();

            try {
                const { data } = await worker.recognize(imageData);
                const newWords = [];
                for (const word of data.words) {
                    if (word.confidence > 60 && word.text.length > 3) {
                        const { x0, y0, x1, y1 } = word.bbox;
                        const w = x1 - x0;
                        const h = y1 - y0;
                        
                        newWords.push({
                            text: word.text,
                            x: x0,
                            y: y0,
                            w: w,
                            h: h,
                        });
                    }
                }
                
                recognizedWords = recognizedWords.concat(newWords);

                statusText.textContent = ` ${recognizedWords.length} Wörter insgesamt gefunden. Scanne erneut...`;

            } catch (error) {
                console.error(error);
                statusText.textContent = "Ein Fehler ist aufgetreten.";
            } finally {
                isRecognizing = false;
                progressBarContainer.classList.add('hidden');
            }
        }

        // GEÄNDERT: Funktion zur Anpassung bei Fenstergrößenänderung
        function windowResized() {
            resizeCanvas(windowWidth, windowHeight);
            calculateLayout();
            // Optional: Erkannte Wörter löschen, da ihre Positionen nicht mehr stimmen
            recognizedWords = []; 
        }
    </script>
</body>
</html>

